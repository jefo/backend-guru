---
interface Annotation {
  line: number;
  text: string;
}

interface Props {
  code: string;
  language?: string;
  annotations: Annotation[];
}

const { code, language = "typescript", annotations } = Astro.props;

// Разделяем код на строки для добавления номеров строк
const codeLines = code.trim().split("\n");
---

<div class="annotated-code">
  <div class="code-container">
    <div class="code-with-lines">
      <div class="line-numbers">
        {
          codeLines.map((_, index) => (
            <div class="line-number">{index + 1}</div>
          ))
        }
      </div>
      <pre><code class={language}>{code}</code></pre>
    </div>

    <div class="annotations">
      {
        annotations.map((annotation) => (
          <div
            class="annotation"
            style={`top: ${(annotation.line - 1) * 24}px;`}
          >
            <div class="annotation-marker">{annotation.line}</div>
            <div class="annotation-content">{annotation.text}</div>
          </div>
        ))
      }
    </div>
  </div>

  <div class="code-actions">
    <button class="copy-button">Копировать код</button>
  </div>
</div>

<script>
  // Копирование кода
  const copyButton = document.querySelector(
    ".copy-button",
  ) as HTMLButtonElement | null;
  const codeElement = document.querySelector(
    ".annotated-code code",
  ) as HTMLElement | null;

  if (copyButton && codeElement) {
    copyButton.addEventListener("click", () => {
      const codeText = codeElement.textContent;

      if (codeText) {
        navigator.clipboard.writeText(codeText).then(() => {
          // Изменяем текст кнопки на "Скопировано!"
          const originalText = copyButton.textContent;
          copyButton.textContent = "Скопировано!";
          copyButton.classList.add("copied");

          // Возвращаем исходный текст через 2 секунды
          setTimeout(() => {
            copyButton.textContent = originalText;
            copyButton.classList.remove("copied");
          }, 2000);
        });
      }
    });
  }
</script>

<style>
  .annotated-code {
    margin: 2rem 0;
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .code-container {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: 0;
  }

  .code-with-lines {
    display: flex;
    background-color: #282c34;
  }

  .line-numbers {
    padding: 1rem 0.5rem;
    background-color: #21252b;
    color: #636d83;
    text-align: right;
    user-select: none;
  }

  .line-number {
    font-family: "Fira Code", monospace;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  pre {
    margin: 0;
    padding: 1rem 1rem 1rem 0;
    overflow-x: auto;
    background-color: #282c34;
    color: #abb2bf;
    flex-grow: 1;
  }

  code {
    font-family: "Fira Code", monospace;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .annotations {
    position: relative;
    background-color: #f8f9fa;
    padding: 1rem 0;
  }

  .annotation {
    position: relative;
    display: flex;
    align-items: flex-start;
    margin: 0.5rem 0;
  }

  .annotation-marker {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    background-color: #4a6cf7;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    margin-right: 0.75rem;
    margin-left: 0.75rem;
  }

  .annotation-content {
    background-color: white;
    padding: 0.75rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    font-size: 0.9rem;
    flex-grow: 1;
    margin-right: 1rem;
  }

  .code-actions {
    padding: 0.75rem;
    background-color: #f1f3f5;
    text-align: right;
  }

  .copy-button {
    background-color: #4a6cf7;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .copy-button:hover {
    background-color: #3a5bd9;
  }

  .copy-button.copied {
    background-color: #4caf50;
  }

  @media (max-width: 768px) {
    .code-container {
      grid-template-columns: 1fr;
    }

    .annotations {
      padding: 1rem;
    }

    .annotation {
      position: static;
      margin: 1rem 0;
    }
  }

  @media (prefers-color-scheme: dark) {
    .annotations {
      background-color: #1e1e2e;
    }

    .annotation-content {
      background-color: #252836;
      color: #e0e0e0;
    }

    .code-actions {
      background-color: #252525;
    }
  }
</style>
